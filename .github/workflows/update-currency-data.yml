name: Update Currency Data

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-currency-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Fetch currency and token data
        run: |
          # Create scripts dir if it doesn't exist
          mkdir -p scripts
          
          # Create the update script
          cat > scripts/update-data.js << 'EOF'
          const https = require('https');
          const fs = require('fs');
          const path = require('path');
          
          const currencyDataPath = path.join('src', 'Data.lua');
          const tokenDataPath = path.join('src', 'TokenData.lua');
          const apiUrl = 'https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.json';
          
          // Get current date in YYYY-MM-DD format
          const today = new Date();
          const dateString = today.toISOString().split('T')[0];
          
          // WoW Token data
          // We'll use manual data with occasional updates here since Blizzard's API requires OAuth
          // In a production environment, you'd want to use the Blizzard API
          const tokenPriceData = {
            US: {
              goldPrice: 245750,  // Gold cost of a token
              realPrice: 20,      // USD cost of a token
              currency: "USD",
              goldValue: 20 / 245750, // USD value of 1 gold
            },
            EU: {
              goldPrice: 313420,  // Gold cost of a token
              realPrice: 20,      // EUR cost of a token
              currency: "EUR",
              goldValue: 20 / 313420, // EUR value of 1 gold
            },
            KR: {
              goldPrice: 176420,  // Gold cost of a token
              realPrice: 22000,   // KRW cost of a token  
              currency: "KRW",
              goldValue: 22000 / 176420, // KRW value of 1 gold
            },
            TW: {
              goldPrice: 184260,  // Gold cost of a token
              realPrice: 500,     // TWD cost of a token
              currency: "TWD",
              goldValue: 500 / 184260, // TWD value of 1 gold
            },
          };
          
          // Function to fetch token data from external sources (if available)
          const fetchTokenData = async () => {
            try {
              // Try to fetch from wowtokenprices.com API
              return new Promise((resolve, reject) => {
                https.get('https://wowtokenprices.com/current_prices.json', (res) => {
                  let data = '';
          
                  res.on('data', (chunk) => {
                    data += chunk;
                  });
          
                  res.on('end', () => {
                    try {
                      const tokenData = JSON.parse(data);
          
                      // Format for our needs
                      const formattedData = {
                        US: {
                          goldPrice: tokenData.us.current_price,
                          realPrice: 20,
                          currency: "USD",
                          goldValue: 20 / tokenData.us.current_price
                        },
                        EU: {
                          goldPrice: tokenData.eu.current_price,
                          realPrice: 20,
                          currency: "EUR",
                          goldValue: 20 / tokenData.eu.current_price
                        },
                        KR: {
                          goldPrice: tokenData.kr.current_price,
                          realPrice: 22000,
                          currency: "KRW",
                          goldValue: 22000 / tokenData.kr.current_price
                        },
                        TW: {
                          goldPrice: tokenData.tw.current_price,
                          realPrice: 500,
                          currency: "TWD",
                          goldValue: 500 / tokenData.tw.current_price
                        }
                      };
          
                      resolve(formattedData);
                    } catch (err) {
                      console.warn("Error parsing token data:", err);
                      resolve(tokenPriceData); // Use fallback data
                    }
                  });
                }).on('error', (err) => {
                  console.warn("Error fetching token data:", err);
                  resolve(tokenPriceData); // Use fallback data
                });
              });
            } catch (error) {
              console.warn("Error in fetchTokenData:", error);
              return tokenPriceData; // Use fallback data
            }
          };
          
          // Function to generate TokenData.lua
          const generateTokenDataLua = (tokenData) => {
            let luaTable = `-- Auto-generated token data file\n`;
            luaTable += `-- Last updated: ${dateString}\n\n`;
            luaTable += `PeaversCurrencyData = PeaversCurrencyData or {}\n\n`;
            luaTable += `-- WoW Token prices across regions\n`;
            luaTable += `PeaversCurrencyData.wowToken = {\n`;
          
            // Add token data for each region
            for (const [region, data] of Object.entries(tokenData)) {
              luaTable += `  ${region} = {\n`;
              luaTable += `    goldPrice = ${Math.round(data.goldPrice)},  -- Gold cost of a token\n`;
              luaTable += `    realPrice = ${data.realPrice},      -- ${data.currency} cost of a token\n`;
              luaTable += `    currency = "${data.currency}",\n`;
              luaTable += `    goldValue = ${data.goldValue.toFixed(10)}, -- ${data.currency} value of 1 gold\n`;
              luaTable += `  },\n`;
            }
          
            luaTable += `}\n\n`;
          
            // Add helper functions
            luaTable += `-- Helper functions for token data access (these will be directly accessible)\n`;
            luaTable += `function PeaversCurrencyData:GetGoldValue(region, currency)\n`;
            luaTable += `  region = region or "US"\n`;
            luaTable += `  local tokenData = self.wowToken[region]\n`;
            luaTable += `  if not tokenData then return nil end\n\n`;
            luaTable += `  currency = currency or tokenData.currency\n`;
            luaTable += `  \n`;
            luaTable += `  -- If the requested currency is the same as the region's currency, return the gold value\n`;
            luaTable += `  if currency == tokenData.currency then\n`;
            luaTable += `    return tokenData.goldValue\n`;
            luaTable += `  end\n\n`;
            luaTable += `  -- Otherwise, convert the gold value from the region's currency to the requested currency\n`;
            luaTable += `  return self:ConvertCurrency(tokenData.goldValue, tokenData.currency, currency)\n`;
            luaTable += `end\n`;
          
            return luaTable;
          };
          
          // Fetch currency exchange rates
          const fetchCurrencyData = () => {
            return new Promise((resolve, reject) => {
              https.get(apiUrl, (res) => {
                let data = '';
          
                res.on('data', (chunk) => {
                  data += chunk;
                });
          
                res.on('end', () => {
                  try {
                    const currencyData = JSON.parse(data);
          
                    // Start building Lua table
                    let luaTable = `-- Auto-generated currency data file\n`;
                    luaTable += `-- Last updated: ${dateString}\n\n`;
                    luaTable += `PeaversCurrencyData = PeaversCurrencyData or {}\n`;
                    luaTable += `PeaversCurrencyData.lastUpdated = "${dateString}"\n\n`;
                    luaTable += `-- Currency rates with USD as base\n`;
                    luaTable += `PeaversCurrencyData.rates = {\n`;
          
                    // Add USD as base currency first
                    luaTable += `  USD = {\n`;
          
                    // Include only major currencies and a few useful ones
                    const majorCurrencies = ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'CHF', 'CNY', 'HKD', 'NZD', 'KRW', 'TWD'];
          
                    // Add USD rates
                    for (const currency in currencyData.usd) {
                      const currencyCode = currency.toUpperCase();
                      if (majorCurrencies.includes(currencyCode)) {
                        luaTable += `    ${currencyCode} = ${currencyData.usd[currency]},\n`;
                      }
                    }
                    luaTable += `  },\n`;
          
                    // Fetch and add other base currencies
                    const promises = majorCurrencies.slice(1).map(currency => {
                      return new Promise((resolve, reject) => {
                        const currencyApiUrl = `https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/${currency.toLowerCase()}.json`;
          
                        https.get(currencyApiUrl, (currencyRes) => {
                          let currencyRateData = '';
          
                          currencyRes.on('data', (chunk) => {
                            currencyRateData += chunk;
                          });
          
                          currencyRes.on('end', () => {
                            try {
                              const currencyRates = JSON.parse(currencyRateData);
                              const baseCurrency = currency.toUpperCase();
          
                              let currencySection = `  ${baseCurrency} = {\n`;
          
                              for (const targetCurrency in currencyRates[currency.toLowerCase()]) {
                                const targetCode = targetCurrency.toUpperCase();
                                if (majorCurrencies.includes(targetCode)) {
                                  currencySection += `    ${targetCode} = ${currencyRates[currency.toLowerCase()][targetCurrency]},\n`;
                                }
                              }
          
                              currencySection += `  },\n`;
                              resolve(currencySection);
                            } catch (err) {
                              reject(err);
                            }
                          });
                        }).on('error', (err) => {
                          reject(err);
                        });
                      });
                    });
          
                    Promise.all(promises)
                      .then(currencySections => {
                        for (const section of currencySections) {
                          luaTable += section;
                        }
          
                        luaTable += `}\n\n`;
                        luaTable += `-- Currency symbols\n`;
                        luaTable += `PeaversCurrencyData.symbols = {\n`;
                        luaTable += `  USD = "$",\n`;
                        luaTable += `  EUR = "€",\n`;
                        luaTable += `  GBP = "£",\n`;
                        luaTable += `  JPY = "¥",\n`;
                        luaTable += `  CAD = "C$",\n`;
                        luaTable += `  AUD = "A$",\n`;
                        luaTable += `  CHF = "Fr",\n`;
                        luaTable += `  CNY = "¥",\n`;
                        luaTable += `  HKD = "HK$",\n`;
                        luaTable += `  NZD = "NZ$",\n`;
                        luaTable += `  KRW = "₩",\n`;
                        luaTable += `  TWD = "NT$",\n`;
                        luaTable += `}\n`;
          
                        resolve(luaTable);
                      })
                      .catch(err => {
                        reject(err);
                      });
          
                  } catch (err) {
                    reject(err);
                  }
                });
              }).on('error', (err) => {
                reject(err);
              });
            });
          };
          
          // Main function to run everything
          const main = async () => {
            try {
              // Fetch token data
              console.log("Fetching WoW Token data...");
              const tokenData = await fetchTokenData();
          
              // Generate TokenData.lua
              console.log("Generating TokenData.lua...");
              const tokenLua = generateTokenDataLua(tokenData);
              fs.writeFileSync(tokenDataPath, tokenLua);
              console.log(`Token data updated and saved to ${tokenDataPath}`);
          
              // Fetch currency data
              console.log("Fetching currency exchange rates...");
              const currencyLua = await fetchCurrencyData();
              fs.writeFileSync(currencyDataPath, currencyLua);
              console.log(`Currency data updated and saved to ${currencyDataPath}`);
          
              console.log("All data updated successfully!");
            } catch (error) {
              console.error("Error in main function:", error);
              process.exit(1);
            }
          };
          
          // Run the main function
          main();
          EOF
          
          # Make the script executable
          chmod +x scripts/update-data.js
          
          # Run the script
          node scripts/update-data.js

      - name: Commit and push changes
        env:
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          # Configure Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Commit and push changes
          git add src/Data.lua src/TokenData.lua
          git commit -m "Update currency and token data - $(date +'%Y-%m-%d')"

          # Push changes using the personal GitHub token
          git remote set-url origin https://x-access-token:${PERSONAL_ACCESS_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          git push